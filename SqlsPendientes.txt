			
select * from Columnas where Tabla = 'ReporteCreditosPDF' and Campo = 'FechaUltimoPago'
update Columnas set Formato = 'dd-MM-yyyy' where Tabla = 'ReporteCreditosPDF' and Campo = 'FechaUltimoPago'

declare @tabla as table(id bigint,serie varchar(20), folio int);

insert into @tabla
select e.Id, e.SeriePadre, FolioPadre from EstadoCuenta e
where Plazo > 0 and Saldo > 0 and (e.Cancelado = 0) and e.EsPadre = 1 
and e.UltimoPago is null

declare @idcuenta bigint;
declare @serie varchar(20);
declare @folio int;
declare @UltimoPago decimal(15,2);
declare @FechaUltimoPago datetime;

select count(*) from @tabla

select top 1 @idcuenta = id, @serie = serie, @folio = folio from @tabla;

while(@idcuenta > 0)
begin
		
	set @UltimoPago = null;
	set @FechaUltimoPago = null;
	
	select top 1 @UltimoPago = Abono, @FechaUltimoPago = Fecha from EstadoCuenta(nolock) ep 
				where ep.SeriePadre = @serie and ep.FolioPadre = @folio 
				and ep.Cancelado = 0 and ConceptoCXC = 'PAG' order by ep.Fecha desc

	if @UltimoPago > 0
	begin
		--print cast(@UltimoPago as varchar(100);
		update EstadoCuenta set UltimoPago = @UltimoPago, FechaUltimoPago = @FechaUltimoPago where Id = @idcuenta;
	end
				
	delete from @tabla where id = @idcuenta;

	select top 1 @idcuenta = id, @serie = serie, @folio = folio from @tabla;
	
end