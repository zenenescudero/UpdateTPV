
create table Inventario
(
  Id bigint not null PRIMARY key,
  ArticuloId bigint not null,
  SucursalId int not null,
  Saldo decimal(15,4) not null,
  Enviado int default 0,
  Version bigint not null default 1
)


INSERT [dbo].[Columnas] ([Id], [Tabla], [Campo], [Descripcion], [Largo], [Formato]) VALUES (424, N'ReporteTurnoVentaPDF', N'Operacion', N'Operaci√≥n', 50, N'')
INSERT [dbo].[Columnas] ([Id], [Tabla], [Campo], [Descripcion], [Largo], [Formato]) VALUES (425, N'ReporteTurnoVentaPDF', N'Fecha', N'Fecha', 55, N'dd-MM-yyyy')
INSERT [dbo].[Columnas] ([Id], [Tabla], [Campo], [Descripcion], [Largo], [Formato]) VALUES (426, N'ReporteTurnoVentaPDF', N'FormaPagoDesc', N'Forma de Pago', 75, N'')
INSERT [dbo].[Columnas] ([Id], [Tabla], [Campo], [Descripcion], [Largo], [Formato]) VALUES (428, N'ReporteTurnoVentaPDF', N'Cliente', N'Cliente', 185, N'')
INSERT [dbo].[Columnas] ([Id], [Tabla], [Campo], [Descripcion], [Largo], [Formato]) VALUES (429, N'ReporteTurnoVentaPDF', N'QUIEN', N'Usuario', 70, N'')
INSERT [dbo].[Columnas] ([Id], [Tabla], [Campo], [Descripcion], [Largo], [Formato]) VALUES (430, N'ReporteTurnoVentaPDF', N'Serie', N'Serie', 55, N'')
INSERT [dbo].[Columnas] ([Id], [Tabla], [Campo], [Descripcion], [Largo], [Formato]) VALUES (431, N'ReporteTurnoVentaPDF', N'Folio', N'Folio', 65, N'')
INSERT [dbo].[Columnas] ([Id], [Tabla], [Campo], [Descripcion], [Largo], [Formato]) VALUES (432, N'ReporteTurnoVentaPDF', N'Cargo', N'Total', 85, N'c2')
SET IDENTITY_INSERT [dbo].[Columnas] OFF


/*

delete from InventarioMovimientos 

delete from Inventario

delete from Articulos


delete from DB_Paraiso.dbo.DocRelPago
delete from DB_Paraiso.dbo.ComplementoPago

delete from DB_Paraiso.dbo.FacturasDetalle
delete from DB_Paraiso.dbo.Facturas

delete from DB_Paraiso.dbo.NotasCreditoDetalle
delete from DB_Paraiso.dbo.NotasCredito

delete from DB_Paraiso.dbo.CfdiCancelados
delete from DB_Paraiso.dbo.CfdiRelacionado

delete from DB_Paraiso.dbo.EstadoCuenta

delete from DB_Paraiso.dbo.TicketsDetalle
delete from DB_Paraiso.dbo.ticketsCancelados
delete from DB_Paraiso.dbo.Tickets

delete from DB_Paraiso.dbo.OrdenCompraDetalle
delete from DB_Paraiso.dbo.OrdenCompra

delete from DB_Paraiso.dbo.PresupuestoDetalle
delete from DB_Paraiso.dbo.Presupuesto

delete from DB_Paraiso.dbo.TraspasoDetalle
delete from DB_Paraiso.dbo.Traspaso

/////////////////////////

delete from DB_Mendez.dbo.DocRelPago
delete from DB_Mendez.dbo.ComplementoPago

delete from DB_Mendez.dbo.FacturasDetalle
delete from DB_Mendez.dbo.Facturas

delete from DB_Mendez.dbo.NotasCreditoDetalle
delete from DB_Mendez.dbo.NotasCredito

delete from DB_Mendez.dbo.CfdiCancelados
delete from DB_Mendez.dbo.CfdiRelacionado

delete from DB_Mendez.dbo.EstadoCuenta

delete from DB_Mendez.dbo.TicketsDetalle
delete from DB_Mendez.dbo.ticketsCancelados
delete from DB_Mendez.dbo.Tickets

delete from DB_Mendez.dbo.OrdenCompraDetalle
delete from DB_Mendez.dbo.OrdenCompra

delete from DB_Mendez.dbo.PresupuestoDetalle
delete from DB_Mendez.dbo.Presupuesto

delete from DB_Mendez.dbo.TraspasoDetalle
delete from DB_Mendez.dbo.Traspaso



*/


  insert into [ConfiguracionApp] values(19,'PlantillaPDF','Paraiso')


if(select count(*) from [UsuarioOpcionesMenu] where UsuarioId = (select Id from Usuarios where [Login]='ADMIN') ) != (select count(*) from OpcionesMenu) 
begin
    delete from [UsuarioOpcionesMenu] where UsuarioId = (select Id from Usuarios where [Login]='ADMIN') 

  insert into [UsuarioOpcionesMenu](UsuarioId,OpcionId,Crear,Editar,Eliminar,Consultar) 
        select s.Id,o.Id,1,1,1,1 from Usuarios s, OpcionesMenu o
        where [Login]='ADMIN'
end

if(select count(*) from [UsuariosSucursal] where UsuarioId = (select Id from Usuarios where [Login]='ADMIN') ) != (select count(*) from Sucursales) 
begin
  delete from [UsuariosSucursal] where UsuarioId = (select Id from Usuarios where [Login]='ADMIN')

  insert into [UsuariosSucursal](SucursalId, UsuarioId) 
        select s.Id, u.Id from Sucursales s, Usuarios u
        where [Login]='ADMIN'
end



create table OrdenCompra(
  Id bigint not null PRIMARY key,
  SucursalId int not null,
  ProveedorId bigint not null,
  FolioInterno bigint not null,
  Serie varchar(5) null,
  Folio varchar(20) null,
  UUID varchar(50) null,
  FechaSolicitud datetime null,
  FechaEntrega datetime null,
  FechaRegistro datetime null,
  SubTotal decimal(15,2) not null,
  Impuestos decimal(15,2) not null,
  Descuento decimal(15,2) not null,
  Total decimal(15,2) not null,
  UsuarioId int null,
  QUIEN VARCHAR(50),
  CUANDO datetime null,
  EQUIPO varchar(50) null,
  Enviado int default 0,
  [Version] bigint not null default 1
)

go

create table OrdenCompraDetalle(
  Id bigint not null PRIMARY key,
  IdOrdenCompra bigint not null,
  SucursalId int not null,
  Partida int not null,
  ClaveProdServ varchar(10) null,
  ClaveUnidad varchar(10) null,
  CodigoProveedor varchar(30) null, 
  Articulo varchar(15) not null,
  Descripcion varchar(1000) not null,
  ArticuloId bigint not null,
  ArticuloSis varchar(15) not null,
  DescripcionSis varchar(1000) not null,  
  Cantidad decimal(10,3) not null,  
  Unidad varchar(50) not null,
  ValorUnitario decimal(15,2) not null,
  Importe decimal(15,2) not null,
  Descuento decimal(15,2) not null,
  ObjetoImp varchar(5) null,
  BaseIva decimal(15 ,2) not null,
  Iva decimal(15,4) not null,
  IvaVal decimal(15,4) not null,
  BaseIeps decimal(15,2) not null,
  Ieps decimal(15,2) not null,
  IepsVal decimal(15,2) not null, 
  TotalUnitario decimal(15,2) not null,
  Total decimal(15,2) not null,
  UsuarioId int null,
  QUIEN VARCHAR(50) null,
  CUANDO datetime null,
  EQUIPO varchar(50),
  Enviado int default 0,  
  [Version] bigint not null default 1
)

insert into Columnas(Tabla,Campo,Descripcion,Largo,Formato)
values('OrdenCompra','FolioInterno', 'Folio Interno', 70,'')


create table FoliosInternos(
  Id bigint not null identity(1,1) primary key,
  Tabla varchar(50) not null unique,
  Folio bigint not null
)


delete from Columnas where Tabla = 'OrdenCompra' and Campo ='Id'


create table Tickets(
  Id bigint not null PRIMARY key,
  SucursalId int not null,
  ClienteId bigint null,
  Observaciones varchar(500) null,
  Fecha datetime null,
  FolioInterno bigint not null,
  Serie varchar(5) null,
  Folio int null,
  UUID varchar(50) null,
  Moneda varchar(5) null,
  TipoCambio decimal(15,6) null,
  Total decimal(15,2) null,
  FormaPago varchar(5) null,
  FormaPagoDesc varchar(50) null,
  UsoCFDI varchar(5) null,
  UsoCFDIDesc varchar(50) null,
  MetodoPago varchar(5) null,
  MetodoPagoDesc varchar(50) null,
  Banco varchar(50) null,
  Referencia varchar(50) null,
  Plazo int not null default 0,
  UsuarioId int null,
  QUIEN VARCHAR(50) null,
  CUANDO datetime null,
  EQUIPO varchar(50),
  Cancelado int default 0,
  Facturado int default 0,
  Enviado int default 0,  
  [Version] bigint not null default 1
)


insert into Columnas(Tabla,Campo,Descripcion,Largo,Formato)
values('tickets','FolioInterno', 'Folio Interno', 70,'')


delete from Columnas where  Tabla = 'tickets' and Campo = 'Id'


create table Presupuesto(
  Id bigint not null PRIMARY KEY,
  SucursalId int not null,
  ClienteId bigint null,
  Observaciones varchar(500) null,
  FolioInterno bigint not null,
  Fecha datetime null,
  Total decimal(15,2) null,
  UsuarioId int null,
  QUIEN VARCHAR(50) null,
  CUANDO datetime null,
  EQUIPO varchar(50)
)



alter table InventarioMovimientos add FolioInterno bigint not null default 0

insert into Columnas(Tabla,Campo,Descripcion,Largo,Formato)
values('Presupuesto','FolioInterno', 'Folio Interno', 70,'')


insert into Columnas(Tabla,Campo,Descripcion,Largo,Formato)
values('Inventario','FolioInterno', 'Folio Interno', 70,'')


delete from Columnas where  Tabla = 'Inventario' and Campo = 'Id'
delete from Columnas where  Tabla = 'Inventario' and Campo = 'IdTicket'
delete from Columnas where  Tabla = 'Inventario' and Campo = 'FolioCompra'


insert into FoliosInternos(Tabla,Folio)
values('InventarioMovimientos',10000)

insert into FoliosInternos(Tabla,Folio)
values('CAT_CONCEPTOSINV',300)



  insert into [ConfiguracionApp] values(20,'DiasConsultaAtras','30')


insert into FoliosInternos(Tabla,Folio)
values('Clientes',20000)

alter table facturas alter column [MetodoPago] varchar(50) null



INSERT INTO articulos(
       [Id],[ARTICULO] ,[Descripcion]
      ,[ProveedorId] ,[SeccionId]
      ,[MarcaId] ,[Activo]
      ,[Unidad]  ,[BARRAS]
      ,[CLAVEPRODSERV]  ,[CLAVEPRODSERV_Desc]
      ,[CLAVEUNIDAD] ,[CLAVEUNIDAD_Desc]
      ,[PrecioCompra]  ,[Margen], [Exento]
      ,[PrecioUnitario] ,[ImpuestoIva]
      ,[ImpuestoIeps]    ,[ImpuestoIvaVal]
      ,[ImpuestoIepsVal],[PrecioVenta]
      ,[Margen3],[Precio3],[Margen6]
      ,[Precio6] ,[Margen9] ,[Precio9]
      ,[Margen12] ,[Precio12] ,[Margen18] ,[Precio18]
    ,[UsuarioId],[QUIEN],[CUANDO],[EQUIPO],[Enviado],[Version])
      

SELECT ROW_NUMBER()  over (order by a.ARTICULO) Id, a.ARTICULO,a.DESCRIPCION
,(SELECT TOP 1 Id FROM Proveedores p WHERE p.Proveedor = a.Proveedor) ProveedorId
,(SELECT TOP 1 Id FROM CAT_SECCIONES s WHERE s.Id = a.CODIGOSECCION) SeccionId
,(SELECT TOP 1 Id FROM CAT_MARCAS m 
            WHERE m.Marca =(SELECT TOP 1 Marca FROM  [DB_COMPIDTFAC].dbo.marcas m1 WHERE m1.CODIGOMARCA = a.CODIGOMARCA) 
            and m.Descripcion =(SELECT TOP 1 m2.DESCRIPCION FROM  [DB_COMPIDTFAC].dbo.marcas m2 WHERE m2.CODIGOMARCA = a.CODIGOMARCA)) MarcaId
,1 Activo
,a.Unidad,a.BARRAS
,(SELECT cc.C_CLAVEPRODSERV from [DB_COMPIDTFAC].dbo.CAT_CLAVEPRODSERV cc WHERE cc.DESCRIPCION = a.CLAVEPRODSERV) CLAVEPRODSERV
,a.CLAVEPRODSERV CLAVEPRODSERVDesc
,(SELECT ccM.C_CLAVEUNIDAD from [DB_COMPIDTFAC].dbo.CAT_CLAVEUNIDAD ccM WHERE ccM.NOMBRE = a.CLAVEUNIDAD) CLAVEUNIDAD
,a.CLAVEUNIDAD CLAVEUNIDADDesc
,cast(a.COSTOLISTA AS decimal(15,4)) as PrecioCompra
,cast(P.MARGEN AS decimal(15,4)) as margen 
, 0 as exento
,0 PUnitario
,cast( a.Impuesto1 AS decimal(15,4)) as Iva
,cast( isnull(a.Impuesto2,0) AS decimal(15,4)) Ieps
,0 as IvaVal
,cast(0 as decimal(15,4)) IepsVal
,p.PRECIO
 --, Pventa = 0
 ,cast(P.MARGENESPECIAL AS decimal(15,3)) Margen3
 ,p.ESPECIAL precio3
 --,0 precio3
 ,cast(P.MARGENMINIMO AS decimal(15,4)) Margen6
 ,p.PRECIOMINIMO precio6
 --,0 precio6
 ,cast(P.MARGENMAYOREO AS decimal(15,4)) margen9
 ,p.MAYOREO Pecio9
 --,Pecio9  = 0
 ,0 margen12
 ,Precio12 = 0
 ,0 margen18  
 ,Precio18 = 0
 ,0 as usuarioid
 ,a.QUIEN
 ,a.CUANDO
 ,a.DONDE
 ,1 as enviado
 ,1 as [Version]
 FROM [DB_COMPIDTFAC].dbo.ARTICULOS a
  left JOIN [DB_COMPIDTFAC].dbo.PREMARART P ON a.ARTICULO=P.ARTICULO 
 WHERE a.CLAVEPRODSERV IS NOT NULL and a.ARTICULO = 2260
